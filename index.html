<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Placar de V√¥lei com Configura√ß√£o Inicial</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .hidden {
      display: none;
    }
    .btn {
      margin: 5px 0;
      padding: 8px 12px;
      cursor: pointer;
    }
    input[type="text"], select {
      padding: 6px;
      width: 200px;
      margin-bottom: 10px;
    }
    .players-container {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .team {
      flex: 1;
      margin-right: 10px;
    }
    .team:last-child {
      margin-right: 0;
    }
    #finishedGamesSetupList div, #finishedGamesList div {
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <h1>Configura√ß√£o do Jogo de V√¥lei</h1>

  <div id="setupContainer">
    <div>
      <label for="teamAName">Nome da Dupla 1:</label><br />
      <input type="text" id="teamAName" placeholder="Nome da Dupla 1" autocomplete="off"/>
    </div>
    <div>
      <label for="teamAPlayers">Jogadores da Dupla 1 (separe por v√≠rgula):</label><br />
      <input type="text" id="teamAPlayers" placeholder="Ex: Ana,Bia" autocomplete="off"/>
    </div>
    <div>
      <label for="teamBName">Nome da Dupla 2:</label><br />
      <input type="text" id="teamBName" placeholder="Nome da Dupla 2" autocomplete="off"/>
    </div>
    <div>
      <label for="teamBPlayers">Jogadores da Dupla 2 (separe por v√≠rgula):</label><br />
      <input type="text" id="teamBPlayers" placeholder="Ex: Clara,Duda" autocomplete="off"/>
    </div>
    <div>
      <label for="tournamentPhaseSelect">Fase do Torneio:</label><br />
      <select id="tournamentPhaseSelect">
        <option value="" disabled selected>Selecione a fase</option>
        <option value="Fase de Grupos">Fase de Grupos</option>
        <option value="Quartas de Final">Quartas de Final</option>
        <option value="Semifinal">Semifinal</option>
        <option value="Final">Final</option>
      </select>
    </div>
    <div>
      <label for="initialServerTeam">Escolha o sacador inicial:</label><br />
      <select id="initialServerTeam">
        <option value="" disabled selected>Escolha a dupla</option>
        <option value="A">Dupla 1</option>
        <option value="B">Dupla 2</option>
      </select>
    </div>
    <div>
      <label for="initialServerIndex">√çndice do sacador na dupla (0 para primeiro jogador, 1 para segundo):</label><br />
      <select id="initialServerIndex">
        <option value="" disabled selected>Escolha o √≠ndice</option>
        <option value="0">0</option>
        <option value="1">1</option>
      </select>
    </div>
    <button id="startGameBtn" class="btn">Iniciar Jogo</button>

    <hr />
    <h3>Jogos Finalizados</h3>
    <div id="finishedGamesSetupList"><i>Nenhum jogo finalizado salvo.</i></div>
  </div>

  <div id="gameContainer" class="hidden">
    <h2>Jogo: <span id="displayTeams"></span></h2>
    <div>
      <label for="tournamentPhase">Fase do Torneio:</label>
      <select id="tournamentPhase" onchange="changePhase()">
        <option value="Fase de Grupos">Fase de Grupos</option>
        <option value="Quartas de Final">Quartas de Final</option>
        <option value="Semifinal">Semifinal</option>
        <option value="Final">Final</option>
      </select>
    </div>

    <div id="playersContainer" class="players-container"></div>

    <div>
      <h3>Set <span id="set-info">1</span></h3>
      <div>
        <button class="btn" onclick="addPoint('A')">Ponto para <span id="btnTeamAName"></span></button>
        <button class="btn" onclick="addPoint('B')">Ponto para <span id="btnTeamBName"></span></button>
      </div>
      <div>
        <button class="btn" onclick="undo()">Desfazer √öltima A√ß√£o</button>
        <button class="btn" onclick="finishSet()">Finalizar Set</button>
        <button class="btn" onclick="finishGame()">Finalizar Jogo</button>
      </div>
    </div>

    <pre id="summary"></pre>

    <hr />
    <h3>Jogos Finalizados</h3>
    <div id="finishedGamesList"><i>Nenhum jogo finalizado salvo.</i></div>
  </div>

<script>
  // Estado principal
  let teamAName = "";
  let teamBName = "";
  let teamA = [];
  let teamB = [];
  let scoreA = 0;
  let scoreB = 0;
  let currentSet = 1;
  let sets = [];
  let server = null; // {team: 'A'|'B', index: 0|1}
  let lastScoringTeam = null;
  let tournamentPhase = "";
  let lastServerIndexA = 0;
  let lastServerIndexB = 0;
  let historyStack = [];
  let finishedGames = [];

  // Fun√ß√£o para validar dados do setup antes de iniciar jogo
  function validateSetup(aName, aPlayersArr, bName, bPlayersArr, phase, initialServerTeam, initialServerIndex) {
    if (!aName || !bName) {
      alert("Nome das duplas √© obrigat√≥rio.");
      return false;
    }
    if (aPlayersArr.length !== 2 || bPlayersArr.length !== 2) {
      alert("Cada dupla deve conter exatamente 2 jogadores.");
      return false;
    }
    if (!phase) {
      alert("Selecione a fase do torneio.");
      return false;
    }
    if (initialServerTeam !== "A" && initialServerTeam !== "B") {
      alert("Selecione a dupla do sacador inicial.");
      return false;
    }
    if (initialServerIndex !== 0 && initialServerIndex !== 1) {
      alert("√çndice do sacador deve ser 0 ou 1.");
      return false;
    }
    return true;
  }

  document.getElementById("startGameBtn").addEventListener("click", () => {
    // Ler dados
    const aName = document.getElementById("teamAName").value.trim();
    const aPlayers = document.getElementById("teamAPlayers").value.trim();
    const bName = document.getElementById("teamBName").value.trim();
    const bPlayers = document.getElementById("teamBPlayers").value.trim();
    const phase = document.getElementById("tournamentPhaseSelect").value;
    const initialServerTeam = document.getElementById("initialServerTeam").value;
    const initialServerIndex = parseInt(document.getElementById("initialServerIndex").value, 10);

    const aPlayersArr = aPlayers.split(",").map(p => p.trim()).filter(p => p.length > 0);
    const bPlayersArr = bPlayers.split(",").map(p => p.trim()).filter(p => p.length > 0);

    if (!validateSetup(aName, aPlayersArr, bName, bPlayersArr, phase, initialServerTeam, initialServerIndex)) {
      return;
    }

    // Inicializa estado do jogo
    teamAName = aName;
    teamBName = bName;
    teamA = aPlayersArr;
    teamB = bPlayersArr;
    tournamentPhase = phase;
    server = {team: initialServerTeam, index: initialServerIndex};
    lastServerIndexA = (initialServerTeam === "A") ? initialServerIndex : 0;
    lastServerIndexB = (initialServerTeam === "B") ? initialServerIndex : 0;
    scoreA = 0;
    scoreB = 0;
    currentSet = 1;
    sets = [];
    lastScoringTeam = null;
    historyStack = [];

    // Interface
    document.getElementById("setupContainer").classList.add("hidden");
    document.getElementById("gameContainer").classList.remove("hidden");

    document.getElementById("tournamentPhase").value = tournamentPhase;
    document.getElementById("set-info").textContent = currentSet;
    document.getElementById("btnTeamAName").textContent = teamAName;
    document.getElementById("btnTeamBName").textContent = teamBName;
    document.getElementById("displayTeams").textContent = `${teamAName} vs ${teamBName}`;

    renderPlayers();
    renderSummary();
  });

  // Renderiza jogadores e indica sacador atual
  function renderPlayers() {
    const container = document.getElementById("playersContainer");
    container.innerHTML = "";

    function createTeamDiv(name, players, teamLabel) {
      const div = document.createElement("div");
      div.className = "team";
      const title = document.createElement("h4");
      title.textContent = name;
      div.appendChild(title);

      players.forEach((p, i) => {
        const pElem = document.createElement("p");
        pElem.textContent = `${p} (P${i})`;
        if (server && server.team === teamLabel && server.index === i) {
          pElem.style.fontWeight = "bold";
          pElem.textContent += " üéæ";
        }
        div.appendChild(pElem);
      });

      return div;
    }

    container.appendChild(createTeamDiv(teamAName, teamA, "A"));
    container.appendChild(createTeamDiv(teamBName, teamB, "B"));
  }

  // Atualiza placar e painel visual
  function updateScores() {
    document.getElementById("teamA-score").textContent = scoreA;
    document.getElementById("teamB-score").textContent = scoreB;
  }

  // Adiciona ponto para o time indicado
  function addPoint(team) {
    // Valida√ß√£o b√°sica
    if (team !== "A" && team !== "B") return;

    // Salvar estado anterior para desfazer
    historyStack.push({
      scoreA, scoreB,
      server: {...server},
      lastScoringTeam,
      currentSet,
      lastServerIndexA,
      lastServerIndexB
    });

    if (team === "A") {
      scoreA++;
      lastScoringTeam = "A";
      lastServerIndexA = server.index;
      // Sacador permanece se time pontuou
    } else {
      scoreB++;
      lastScoringTeam = "B";
      lastServerIndexB = server.index;
    }

    // Se time que pontuou √© diferente do sacador, muda sacador para outro jogador da dupla que pontuou
    if (server.team !== team) {
      server.team = team;
      // alterna √≠ndice do sacador na dupla
      if (team === "A") {
        server.index = lastServerIndexA === 0 ? 1 : 0;
        lastServerIndexA = server.index;
      } else {
        server.index = lastServerIndexB === 0 ? 1 : 0;
        lastServerIndexB = server.index;
      }
    }

    renderPlayers();
    renderSummary();
  }

  // Desfaz a √∫ltima a√ß√£o
  function undo() {
    if (historyStack.length === 0) {
      alert("Nada para desfazer.");
      return;
    }
    const lastState = historyStack.pop();
    scoreA = lastState.scoreA;
    scoreB = lastState.scoreB;
    server = lastState.server;
    lastScoringTeam = lastState.lastScoringTeam;
    currentSet = lastState.currentSet;
    lastServerIndexA = lastState.lastServerIndexA;
    lastServerIndexB = lastState.lastServerIndexB;

    document.getElementById("set-info").textContent = currentSet;

    renderPlayers();
    renderSummary();
  }

  // Finaliza o set atual
  function finishSet() {
    if (scoreA === 0 && scoreB === 0) {
      alert("O set n√£o pode ser finalizado com placar zerado.");
      return;
    }
    sets.push({set: currentSet, scoreA, scoreB});
    currentSet++;
    scoreA = 0;
    scoreB = 0;
    lastScoringTeam = null;
    historyStack = [];
    document.getElementById("set-info").textContent = currentSet;

    renderSummary();
    updateScores();
  }

  // Finaliza o jogo, salvando resultado na lista
  function finishGame() {
    if (sets.length === 0) {
      alert("Finalize pelo menos um set antes de finalizar o jogo.");
      return;
    }

    const winner = calculateWinner();
    const finishedGame = {
      teamAName,
      teamBName,
      sets: [...sets],
      winner,
      phase: tournamentPhase
    };
    finishedGames.push(finishedGame);

    // Atualiza lista finalizados
    updateFinishedGamesList();

    // Reset
    document.getElementById("setupContainer").classList.remove("hidden");
    document.getElementById("gameContainer").classList.add("hidden");
  }

  // Calcula vencedor por sets ganhos
  function calculateWinner() {
    let winsA = 0, winsB = 0;
    sets.forEach(s => {
      if (s.scoreA > s.scoreB) winsA++;
      else if (s.scoreB > s.scoreA) winsB++;
    });
    if (winsA > winsB) return teamAName;
    if (winsB > winsA) return teamBName;
    return "Empate";
  }

  // Atualiza o resumo textual e o placar visual
  function renderSummary() {
    updateScores();

    let summaryText = `Fase do Torneio: ${tournamentPhase}\n`;
    summaryText += `Sets jogados: ${sets.length}\n\n`;
    sets.forEach(s => {
      summaryText += `Set ${s.set}: ${teamAName} ${s.scoreA} x ${s.scoreB} ${teamBName}\n`;
    });
    summaryText += `\nPlacar atual: ${teamAName} ${scoreA} x ${scoreB} ${teamBName}\n`;
    summaryText += `Sacador atual: ${server ? (server.team === "A" ? teamA[server.index] : teamB[server.index]) : "N/D"}\n`;

    document.getElementById("summary").textContent = summaryText;
  }

  // Atualiza lista de jogos finalizados na tela
  function updateFinishedGamesList() {
    const container = document.getElementById("finishedGamesList");
    if (finishedGames.length === 0) {
      container.innerHTML = "<i>Nenhum jogo finalizado salvo.</i>";
      return;
    }
    container.innerHTML = "";
    finishedGames.forEach((game, i) => {
      const div = document.createElement("div");
      div.textContent = `${i+1}. ${game.teamAName} vs ${game.teamBName} - Fase: ${game.phase} - Vencedor: ${game.winner} (${game.sets.length} sets)`;
      container.appendChild(div);
    });
  }

  // Atualiza lista de jogos finalizados no setup
  function updateFinishedGamesSetupList() {
    const container = document.getElementById("finishedGamesSetupList");
    if (finishedGames.length === 0) {
      container.innerHTML = "<i>Nenhum jogo finalizado salvo.</i>";
      return;
    }
    container.innerHTML = "";
    finishedGames.forEach((game, i) => {
      const div = document.createElement("div");
      div.textContent = `${i+1}. ${game.teamAName} vs ${game.teamBName} - Vencedor: ${game.winner}`;
      container.appendChild(div);
    });
  }

  // Ao mudar fase no jogo em andamento
  function changePhase() {
    const phaseSelect = document.getElementById("tournamentPhase");
    tournamentPhase = phaseSelect.value;
    renderSummary();
  }
</script>

<!-- Adiciona o placar visual dos pontos, logo ap√≥s o t√≠tulo do set -->
<style>
  #scoreboard {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 40px;
    margin-bottom: 15px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  #scoreboard div {
    font-weight: bold;
    user-select: none;
  }
  #teamA-score {
    font-size: 2.5rem;
    color: #0057e7;
    min-width: 80px;
    text-align: center;
  }
  #teamB-score {
    font-size: 2.5rem;
    color: #d62d20;
    min-width: 80px;
    text-align: center;
  }
  #scoreboard .vs {
    font-size: 1.8rem;
  }
</style>

<script>
  // Inserir o painel de placar visual no DOM depois que a p√°gina carrega
window.onload = function() {
  const setHeading = document.getElementById("set-info");
  if (setHeading) {
    const scoreboard = document.createElement("div");
    scoreboard.id = "scoreboard";
    scoreboard.innerHTML = `
      <div style="display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; max-width: 250px;">
        <div id="teamA-name">${teamAName || 'Dupla 1'}</div>
        <div id="teamB-name" style="text-align: right;">${teamBName || 'Dupla 2'}</div>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center; max-width: 250px;">
        <div id="teamA-score" style="font-size: 2.5rem; color: #0057e7; min-width: 80px; text-align: left;">0</div>
        <div class="vs" style="font-size: 1.8rem;">x</div>
        <div id="teamB-score" style="font-size: 2.5rem; color: #d62d20; min-width: 80px; text-align: right;">0</div>
      </div>
    `;
    setHeading.parentNode.insertBefore(scoreboard, setHeading.nextSibling);
  }
};
</script>
