<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vôlei de Dupla</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f2f2f2;
      padding: 20px;
      text-align: center;
    }
    h1 {
      margin-bottom: 10px;
    }
    .team {
      margin: 20px 0;
    }
    .score {
      font-size: 2rem;
      margin: 10px 0;
    }
    .serving {
      color: green;
      font-weight: bold;
    }
    button, select, input[type="text"] {
      font-size: 1.1rem;
      margin: 5px;
      padding: 8px 15px;
      cursor: pointer;
    }
    .players-inputs {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 10px;
    }
    .players-inputs div {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #summary {
      margin-top: 30px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
      white-space: pre-wrap;
    }
    #historyLog {
      max-height: 150px;
      overflow-y: auto;
      font-size: 0.85rem;
      background: #eee;
      padding: 10px;
      border-radius: 5px;
      margin-top: 15px;
      white-space: pre-wrap;
      text-align: left;
    }
    #savedGamesDashboard {
      position: fixed;
      top: 10px;
      right: 10px;
      background: white;
      width: 350px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 10px;
      display: none;
      text-align: left;
      z-index: 1000;
    }
    #savedGamesDashboard h2 {
      margin-top: 0;
    }
    .saved-game {
      border-bottom: 1px solid #ccc;
      padding: 5px 0;
    }
    .saved-game:last-child {
      border-bottom: none;
    }
    .saved-game button {
      font-size: 0.9rem;
      margin-left: 5px;
      padding: 3px 7px;
    }
    #dashboardToggleBtn {
      position: fixed;
      top: 10px;
      right: 370px;
      padding: 10px 15px;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1001;
    }
  </style>
</head>
<body>
  <h1>Placar - Vôlei de Dupla</h1>

  <div>
    <label for="tournamentPhase">Fase do Torneio:</label>
    <select id="tournamentPhase" onchange="changePhase()">
      <option value="Fase de Grupos">Fase de Grupos</option>
      <option value="Quartas de Final">Quartas de Final</option>
      <option value="Semifinal">Semifinal</option>
      <option value="Final">Final</option>
    </select>
  </div>

  <div id="set-info">Set 1</div>

  <div class="team">
    <h2>Time A</h2>
    <div class="players-inputs" id="teamA-inputs"></div>
    <div id="teamA-players"></div>
    <div class="score" id="scoreA">0</div>
    <button onclick="addPoint('A')">+ Ponto Time A</button>
  </div>

  <div class="team">
    <h2>Time B</h2>
    <div class="players-inputs" id="teamB-inputs"></div>
    <div id="teamB-players"></div>
    <div class="score" id="scoreB">0</div>
    <button onclick="addPoint('B')">+ Ponto Time B</button>
  </div>

  <div style="margin-top: 20px;">
    <button onclick="finishSet()">Finalizar Set</button>
    <button onclick="undo()">Desfazer último ponto</button>
    <button onclick="finishGame()" style="background:#28a745; color:white;">Finalizar Jogo</button>
  </div>

  <div style="margin-top: 20px;">
    <button onclick="exportGame()">Exportar jogo atual (JSON)</button>
    <input type="file" id="importFile" style="display:none" accept=".json" onchange="importGame(event)" />
    <button onclick="document.getElementById('importFile').click()">Importar jogo (JSON)</button>
  </div>

  <div id="summary"></div>

  <button id="dashboardToggleBtn" onclick="toggleDashboard()">Jogos Salvos</button>
  <div id="savedGamesDashboard">
    <h2>Jogos Salvos</h2>
    <div id="savedGamesList">Nenhum jogo salvo.</div>
    <button onclick="closeDashboard()" style="margin-top:10px;">Fechar</button>
    <pre id="savedGameDetails" style="white-space: pre-wrap; margin-top: 15px; background:#f8f9fa; padding:10px; border-radius:5px; max-height:300px; overflow-y:auto; display:none;"></pre>
  </div>

  <script>
    // Estado inicial dos jogadores
    let teamA = ["Ana", "Bia"];
    let teamB = ["Clara", "Duda"];

    // Histórico para undo
    const historyStack = [];

    // Estado do jogo
    let scoreA = 0;
    let scoreB = 0;
    let currentSet = 1;
    let sets = [];
    let server = { team: 'A', index: 0 };  // Quem está sacando
    let lastScoringTeam = null;
    let tournamentPhase = "Fase de Grupos";

    // Controle alternância servidor por time
    let lastServerIndexA = 0;
    let lastServerIndexB = 0;

    // Jogos salvos
    let savedGames = [];

    // --- Funções básicas ---

    function saveState() {
      const state = {
        teamA,
        teamB,
        scoreA,
        scoreB,
        currentSet,
        sets,
        server,
        lastScoringTeam,
        tournamentPhase,
        lastServerIndexA,
        lastServerIndexB,
        historyStack
      };
      localStorage.setItem('voleiState', JSON.stringify(state));
    }

    function loadState() {
      const saved = localStorage.getItem('voleiState');
      if (saved) {
        try {
          const state = JSON.parse(saved);
          teamA = state.teamA ?? ["Ana", "Bia"];
          teamB = state.teamB ?? ["Clara", "Duda"];
          scoreA = state.scoreA ?? 0;
          scoreB = state.scoreB ?? 0;
          currentSet = state.currentSet ?? 1;
          sets = state.sets ?? [];
          server = state.server ?? { team: 'A', index: 0 };
          lastScoringTeam = state.lastScoringTeam ?? null;
          tournamentPhase = state.tournamentPhase ?? "Fase de Grupos";
          lastServerIndexA = state.lastServerIndexA ?? 0;
          lastServerIndexB = state.lastServerIndexB ?? 0;
          document.getElementById("tournamentPhase").value = tournamentPhase;
          document.getElementById("set-info").textContent = `Set ${currentSet}`;
        } catch {
          localStorage.removeItem('voleiState');
        }
      }
    }

    function saveSavedGames() {
      localStorage.setItem('voleiSavedGames', JSON.stringify(savedGames));
    }

    function loadSavedGames() {
      const saved = localStorage.getItem('voleiSavedGames');
      if (saved) {
        try {
          savedGames = JSON.parse(saved);
        } catch {
          savedGames = [];
          localStorage.removeItem('voleiSavedGames');
        }
      }
    }

    // Render dos jogadores com indicação do sacador
    function renderPlayers() {
      // Render time A
      const aHTML = teamA.map((name, i) =>
        (server.team === 'A' && server.index === i)
          ? `<div class="serving">➡️ ${name}</div>`
          : `<div>${name}</div>`
      ).join("");
      document.getElementById("teamA-players").innerHTML = aHTML;

      // Render time B
      const bHTML = teamB.map((name, i) =>
        (server.team === 'B' && server.index === i)
          ? `<div class="serving">➡️ ${name}</div>`
          : `<div>${name}</div>`
      ).join("");
      document.getElementById("teamB-players").innerHTML = bHTML;
    }

    // Render inputs para editar nomes
    function renderPlayerInputs() {
      const containerA = document.getElementById("teamA-inputs");
      const containerB = document.getElementById("teamB-inputs");

      containerA.innerHTML = "";
      containerB.innerHTML = "";

      teamA.forEach((name, i) => {
        const input = document.createElement("input");
        input.type = "text";
        input.value = name;
        input.size = 8;
        input.onchange = e => {
          teamA[i] = e.target.value.trim() || `Jogador A${i + 1}`;
          saveState();
          renderPlayers();
          renderPlayerInputs();
        };
        containerA.appendChild(input);
      });

      teamB.forEach((name, i) => {
        const input = document.createElement("input");
        input.type = "text";
        input.value = name;
        input.size = 8;
        input.onchange = e => {
          teamB[i] = e.target.value.trim() || `Jogador B${i + 1}`;
          saveState();
          renderPlayers();
          renderPlayerInputs();
        };
        containerB.appendChild(input);
      });
    }

    // Atualiza placar
    function updateScores() {
      document.getElementById("scoreA").textContent = scoreA;
      document.getElementById("scoreB").textContent = scoreB;
      renderPlayers();
    }

    // Alternar sacador
    function switchServer() {
      if (server.team === 'A') {
        lastServerIndexB = (lastServerIndexB + 1) % teamB.length;
        server = { team: 'B', index: lastServerIndexB };
      } else {
        lastServerIndexA = (lastServerIndexA + 1) % teamA.length;
        server = { team: 'A', index: lastServerIndexA };
      }
    }

    // Adiciona ponto para time
    function addPoint(team) {
      historyStack.push({
        scoreA,
        scoreB,
        server: { ...server },
        lastServerIndexA,
        lastServerIndexB,
        lastScoringTeam
      });

      if (team === 'A') {
        scoreA++;
      } else {
        scoreB++;
      }
      lastScoringTeam = team;

      // Regra simples de troca de sacador a cada ponto (você pode ajustar)
      switchServer();

      updateScores();
      saveState();
      updateSummary();
    }

    // Desfazer último ponto
    function undo() {
      if (historyStack.length === 0) return alert("Nada para desfazer");
      const lastState = historyStack.pop();
      scoreA = lastState.scoreA;
      scoreB = lastState.scoreB;
      server = lastState.server;
      lastServerIndexA = lastState.lastServerIndexA;
      lastServerIndexB = lastState.lastServerIndexB;
      lastScoringTeam = lastState.lastScoringTeam;
      updateScores();
      saveState();
      updateSummary();
    }

    // Finaliza o set atual, salva no histórico de sets e zera placar para próximo set
    function finishSet() {
      if (scoreA === 0 && scoreB === 0) {
        alert("Não é possível finalizar um set sem pontos.");
        return;
      }

      sets.push({ setNumber: currentSet, scoreA, scoreB });
      currentSet++;
      scoreA = 0;
      scoreB = 0;
      // Resetar sacador pro time A no começo do set
      server = { team: 'A', index: 0 };
      lastServerIndexA = 0;
      lastServerIndexB = 0;
      historyStack.length = 0; // Limpa histórico de undo após finalizar set
      document.getElementById("set-info").textContent = `Set ${currentSet}`;
      updateScores();
      saveState();
      updateSummary();
    }

    // Atualiza o texto da súmula do jogo
    function updateSummary() {
      if (sets.length === 0 && scoreA === 0 && scoreB === 0) {
        document.getElementById("summary").textContent = "Jogo ainda não começou.";
        return;
      }

      let text = `Fase: ${tournamentPhase}\n\nJogadores:\nTime A: ${teamA.join(", ")}\nTime B: ${teamB.join(", ")}\n\n`;

      text += "Sets finalizados:\n";
      if (sets.length === 0) {
        text += "Nenhum.\n";
      } else {
        sets.forEach(s => {
          text += `Set ${s.setNumber}: Time A ${s.scoreA} x Time B ${s.scoreB}\n`;
        });
      }

      text += `\nSet atual (${currentSet}): Time A ${scoreA} x Time B ${scoreB}\n`;
      text += `Sacador: Time ${server.team} - ${server.team === 'A' ? teamA[server.index] : teamB[server.index]}\n`;

      document.getElementById("summary").textContent = text;
    }

    // Finaliza o jogo, salva no histórico de jogos finalizados e limpa o estado atual
    function finishGame() {
      if (sets.length === 0) {
        alert("Finalize pelo menos um set antes de finalizar o jogo.");
        return;
      }

      // Salva o jogo finalizado
      const finishedGame = {
        timestamp: new Date().toISOString(),
        tournamentPhase,
        teamA: [...teamA],
        teamB: [...teamB],
        sets: [...sets],
      };
      savedGames.push(finishedGame);
      saveSavedGames();

      // Resetar estado para jogo novo
      teamA = ["Ana", "Bia"];
      teamB = ["Clara", "Duda"];
      scoreA = 0;
      scoreB = 0;
      currentSet = 1;
      sets = [];
      server = { team: 'A', index: 0 };
      lastScoringTeam = null;
      lastServerIndexA = 0;
      lastServerIndexB = 0;
      historyStack.length = 0;
      tournamentPhase = "Fase de Grupos";
      document.getElementById("tournamentPhase").value = tournamentPhase;
      document.getElementById("set-info").textContent = `Set ${currentSet}`;
      renderPlayerInputs();
      updateScores();
      updateSummary();
      renderSavedGamesList();

      alert("Jogo finalizado e salvo.");
    }

    // Exporta jogo atual para JSON
    function exportGame() {
      const game = {
        teamA,
        teamB,
        scoreA,
        scoreB,
        currentSet,
        sets,
        server,
        lastScoringTeam,
        tournamentPhase
      };
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(game, null, 2));
      const dlAnchor = document.createElement('a');
      dlAnchor.setAttribute("href", dataStr);
      dlAnchor.setAttribute("download", "jogo_volei.json");
      document.body.appendChild(dlAnchor);
      dlAnchor.click();
      dlAnchor.remove();
    }

    // Importa jogo de JSON
    function importGame(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const game = JSON.parse(e.target.result);
          teamA = game.teamA ?? ["Ana", "Bia"];
          teamB = game.teamB ?? ["Clara", "Duda"];
          scoreA = game.scoreA ?? 0;
          scoreB = game.scoreB ?? 0;
          currentSet = game.currentSet ?? 1;
          sets = game.sets ?? [];
          server = game.server ?? { team: 'A', index: 0 };
          lastScoringTeam = game.lastScoringTeam ?? null;
          tournamentPhase = game.tournamentPhase ?? "Fase de Grupos";
          document.getElementById("tournamentPhase").value = tournamentPhase;
          document.getElementById("set-info").textContent = `Set ${currentSet}`;
          historyStack.length = 0;
          renderPlayerInputs();
          updateScores();
          updateSummary();
          saveState();
          alert("Jogo importado com sucesso.");
        } catch {
          alert("Arquivo inválido.");
        }
      };
      reader.readAsText(file);
      event.target.value = ""; // limpar input
    }

    // Alterar fase do torneio
    function changePhase() {
      tournamentPhase = document.getElementById("tournamentPhase").value;
      updateSummary();
      saveState();
    }

    // Toggle da dashboard de jogos salvos
    function toggleDashboard() {
      const dash = document.getElementById("savedGamesDashboard");
      if (dash.style.display === "block") {
        dash.style.display = "none";
        document.getElementById("savedGameDetails").style.display = "none";
      } else {
        dash.style.display = "block";
        renderSavedGamesList();
      }
    }

    function closeDashboard() {
      document.getElementById("savedGamesDashboard").style.display = "none";
      document.getElementById("savedGameDetails").style.display = "none";
    }

    // Render lista de jogos salvos
    function renderSavedGamesList() {
      const container = document.getElementById("savedGamesList");
      container.innerHTML = "";

      if (savedGames.length === 0) {
        container.textContent = "Nenhum jogo salvo.";
        return;
      }

      savedGames.forEach((game, idx) => {
        const dateStr = new Date(game.timestamp).toLocaleString();
        const div = document.createElement("div");
        div.classList.add("saved-game");
        div.innerHTML = `
          <strong>${dateStr}</strong><br>
          Fase: ${game.tournamentPhase}<br>
          Time A: ${game.teamA.join(", ")}<br>
          Time B: ${game.teamB.join(", ")}<br>
          Sets: ${game.sets.length}<br>
          <button onclick="viewSavedGame(${idx})">Ver detalhes</button>
          <button onclick="deleteSavedGame(${idx})" style="background:#dc3545;color:white;">Excluir</button>
        `;
        container.appendChild(div);
      });
    }

    // Visualizar detalhes do jogo salvo
    function viewSavedGame(idx) {
      const game = savedGames[idx];
      if (!game) return;
      const details = `
Fase do Torneio: ${game.tournamentPhase}

Time A: ${game.teamA.join(", ")}
Time B: ${game.teamB.join(", ")}

Sets finalizados:
${game.sets.map(s => `Set ${s.setNumber}: Time A ${s.scoreA} x Time B ${s.scoreB}`).join("\n")}
      `;
      const detailElem = document.getElementById("savedGameDetails");
      detailElem.textContent = details;
      detailElem.style.display = "block";
    }

    // Deletar jogo salvo
    function deleteSavedGame(idx) {
      if (!confirm("Excluir este jogo salvo?")) return;
      savedGames.splice(idx, 1);
      saveSavedGames();
      renderSavedGamesList();
      document.getElementById("savedGameDetails").style.display = "none";
    }

    // Inicialização
    function init() {
      loadState();
      loadSavedGames();
      renderPlayerInputs();
      updateScores();
      updateSummary();
    }

    window.onload = init;
  </script>
</body>
</html>
