<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vôlei de Dupla - Gestão de Jogos</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f2f2f2;
      padding: 20px;
      text-align: center;
    }
    h1, h2, h3 {
      margin-bottom: 10px;
    }
    .team {
      margin: 20px 0;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    .score {
      font-size: 2rem;
      margin: 10px 0;
    }
    .serving {
      color: green;
      font-weight: bold;
    }
    button, select, input[type="text"] {
      font-size: 1.1rem;
      margin: 5px;
      padding: 8px 15px;
      cursor: pointer;
    }
    .players-inputs {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 10px;
    }
    .players-inputs div {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #summary {
      margin-top: 15px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      min-height: 80px;
    }
    #historyLog {
      max-height: 150px;
      overflow-y: auto;
      font-size: 0.85rem;
      background: #eee;
      padding: 10px;
      border-radius: 5px;
      margin-top: 15px;
      white-space: pre-wrap;
      text-align: left;
    }
    #finishedGamesDashboard {
      margin-top: 40px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      text-align: left;
    }
    .finishedGame {
      border-bottom: 1px solid #ccc;
      padding: 8px 0;
    }
    .finishedGame:last-child {
      border-bottom: none;
    }
    .finishedGame > div {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .btn-small {
      padding: 4px 8px;
      font-size: 0.9rem;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <h1>Placar - Vôlei de Dupla (Gerenciamento de Jogos)</h1>

  <div>
    <label for="tournamentPhase">Fase do Torneio:</label>
    <select id="tournamentPhase" onchange="changePhase()">
      <option value="Fase de Grupos">Fase de Grupos</option>
      <option value="Quartas de Final">Quartas de Final</option>
      <option value="Semifinal">Semifinal</option>
      <option value="Final">Final</option>
    </select>
  </div>

  <div id="set-info">Set 1</div>

  <div class="team">
    <h2>Time A</h2>
    <div class="players-inputs" id="teamA-inputs"></div>
    <div id="teamA-players"></div>
    <div class="score" id="scoreA">0</div>
    <button onclick="addPoint('A')">+ Ponto Time A</button>
  </div>

  <div class="team">
    <h2>Time B</h2>
    <div class="players-inputs" id="teamB-inputs"></div>
    <div id="teamB-players"></div>
    <div class="score" id="scoreB">0</div>
    <button onclick="addPoint('B')">+ Ponto Time B</button>
  </div>

  <div style="margin-top: 20px;">
    <button onclick="finishSet()">Finalizar Set</button>
    <button onclick="undo()">Desfazer último ponto</button>
    <button onclick="finishGame()" style="background:#d9534f;color:white;">Finalizar Jogo</button>
  </div>

  <div style="margin-top: 20px;">
    <button onclick="exportGame()">Exportar jogo atual (JSON)</button>
    <input type="file" id="importFile" style="display:none" accept=".json" onchange="importGame(event)" />
    <button onclick="document.getElementById('importFile').click()">Importar jogo (JSON)</button>
  </div>

  <div id="summary"></div>

  <section id="finishedGamesDashboard">
    <h2>Jogos Finalizados</h2>
    <div id="finishedGamesList">
      <!-- Lista de jogos finalizados aqui -->
    </div>
  </section>

  <script>
    // Estado inicial dos jogadores
    let teamA = ["Ana", "Bia"];
    let teamB = ["Clara", "Duda"];

    // Histórico para undo
    const historyStack = [];

    // Estado do jogo atual
    let scoreA = 0;
    let scoreB = 0;
    let currentSet = 1;
    let sets = [];
    let server = { team: 'A', index: 0 };
    let lastScoringTeam = null;
    let tournamentPhase = "Fase de Grupos";

    // Estado geral para jogos finalizados
    let finishedGames = [];

    // Histórico de servidores para alternância
    let lastServerIndexA = 0;
    let lastServerIndexB = 0;

    // --- Funções básicas ---

    function saveState() {
      const state = {
        teamA,
        teamB,
        scoreA,
        scoreB,
        currentSet,
        sets,
        server,
        lastScoringTeam,
        tournamentPhase,
        historyStack,
        lastServerIndexA,
        lastServerIndexB
      };
      localStorage.setItem('voleiState', JSON.stringify(state));
      localStorage.setItem('finishedGames', JSON.stringify(finishedGames));
    }

    function loadState() {
      const saved = localStorage.getItem('voleiState');
      if (saved) {
        try {
          const state = JSON.parse(saved);
          teamA = state.teamA ?? ["Ana", "Bia"];
          teamB = state.teamB ?? ["Clara", "Duda"];
          scoreA = state.scoreA ?? 0;
          scoreB = state.scoreB ?? 0;
          currentSet = state.currentSet ?? 1;
          sets = state.sets ?? [];
          server = state.server ?? { team: 'A', index: 0 };
          lastScoringTeam = state.lastScoringTeam ?? null;
          tournamentPhase = state.tournamentPhase ?? "Fase de Grupos";
          historyStack.length = 0;
          if(state.historyStack) state.historyStack.forEach(h => historyStack.push(h));
          lastServerIndexA = state.lastServerIndexA ?? 0;
          lastServerIndexB = state.lastServerIndexB ?? 0;
          document.getElementById("tournamentPhase").value = tournamentPhase;
          document.getElementById("set-info").textContent = `Set ${currentSet}`;
        } catch {
          localStorage.removeItem('voleiState');
        }
      }

      const finishedSaved = localStorage.getItem('finishedGames');
      if (finishedSaved) {
        try {
          finishedGames = JSON.parse(finishedSaved);
        } catch {
          localStorage.removeItem('finishedGames');
          finishedGames = [];
        }
      }
    }

    function renderPlayers() {
      const aHTML = teamA.map((name, i) =>
        (server.team === 'A' && server.index === i)
          ? `<div class="serving">➡️ ${name}</div>`
          : `<div>${name}</div>`
      ).join("");
      document.getElementById("teamA-players").innerHTML = aHTML;

      const bHTML = teamB.map((name, i) =>
        (server.team === 'B' && server.index === i)
          ? `<div class="serving">➡️ ${name}</div>`
          : `<div>${name}</div>`
      ).join("");
      document.getElementById("teamB-players").innerHTML = bHTML;
    }

    function renderPlayerInputs() {
      const containerA = document.getElementById("teamA-inputs");
      const containerB = document.getElementById("teamB-inputs");

      containerA.innerHTML = "";
      containerB.innerHTML = "";

      teamA.forEach((name, i) => {
        const input = document.createElement("input");
        input.type = "text";
        input.value = name;
        input.size = 8;
        input.onchange = e => {
          teamA[i] = e.target.value.trim() || `Jogador A${i+1}`;
          saveState();
          renderPlayers();
          renderPlayerInputs();
        };
        containerA.appendChild(input);
      });

      teamB.forEach((name, i) => {
        const input = document.createElement("input");
        input.type = "text";
        input.value = name;
        input.size = 8;
        input.onchange = e => {
          teamB[i] = e.target.value.trim() || `Jogador B${i+1}`;
          saveState();
          renderPlayers();
          renderPlayerInputs();
        };
        containerB.appendChild(input);
      });
    }

    function updateScores() {
      document.getElementById("scoreA").textContent = scoreA;
      document.getElementById("scoreB").textContent = scoreB;
    }

    function pushHistory() {
      const snapshot = {
        teamA: [...teamA],
        teamB: [...teamB],
        scoreA,
        scoreB,
        currentSet,
        sets: JSON.parse(JSON.stringify(sets)),
        server: { ...server },
        lastScoringTeam,
        tournamentPhase,
        lastServerIndexA,
        lastServerIndexB
      };
      historyStack.push(snapshot);
      if (historyStack.length > 100) historyStack.shift(); // limite razoável
    }

    function addPoint(team) {
      pushHistory();

      if (team === 'A') {
        scoreA++;
        lastScoringTeam = 'A';
      } else {
        scoreB++;
        lastScoringTeam = 'B';
      }

      // Alternar saque se ponto para quem não estava sacando
      if (server.team !== lastScoringTeam) {
        if (lastScoringTeam === 'A') {
          lastServerIndexA = (lastServerIndexA + 1) % teamA.length;
          server = { team: 'A', index: lastServerIndexA };
        } else {
          lastServerIndexB = (lastServerIndexB + 1) % teamB.length;
          server = { team: 'B', index: lastServerIndexB };
        }
      }

      updateScores();
      renderPlayers();
      renderSummary();
      saveState();
    }

    function undo() {
      if (historyStack.length === 0) return alert("Nada a desfazer");
      const last = historyStack.pop();

      teamA = last.teamA;
      teamB = last.teamB;
      scoreA = last.scoreA;
      scoreB = last.scoreB;
      currentSet = last.currentSet;
      sets = last.sets;
      server = last.server;
      lastScoringTeam = last.lastScoringTeam;
      tournamentPhase = last.tournamentPhase;
      lastServerIndexA = last.lastServerIndexA;
      lastServerIndexB = last.lastServerIndexB;

      document.getElementById("tournamentPhase").value = tournamentPhase;
      document.getElementById("set-info").textContent = `Set ${currentSet}`;

      updateScores();
      renderPlayers();
      renderSummary();
      saveState();
    }

    function finishSet() {
      if(scoreA === scoreB) {
        alert("O set não pode terminar empatado.");
        return;
      }
      sets.push({ setNumber: currentSet, scoreA, scoreB });
      currentSet++;
      scoreA = 0;
      scoreB = 0;
      server = { team: 'A', index: 0 };
      lastServerIndexA = 0;
      lastServerIndexB = 0;
      lastScoringTeam = null;
      historyStack.length = 0; // limpa histórico para o novo set
      document.getElementById("set-info").textContent = `Set ${currentSet}`;
      updateScores();
      renderPlayers();
      renderSummary();
      saveState();
    }

    function changePhase() {
      tournamentPhase = document.getElementById("tournamentPhase").value;
      renderSummary();
      saveState();
    }

    function renderSummary() {
      const summary = [];
      summary.push(`Fase do Torneio: ${tournamentPhase}`);
      summary.push(`Set Atual: ${currentSet}`);
      summary.push(`Placar atual: Time A ${scoreA} x ${scoreB} Time B`);
      summary.push(`Servidor: ${server.team} - ${server.index + 1} (${(server.team === 'A' ? teamA[server.index] : teamB[server.index])})`);
      if (sets.length > 0) {
        summary.push("Sets finalizados:");
        sets.forEach(s => summary.push(`  Set ${s.setNumber}: Time A ${s.scoreA} x ${s.scoreB} Time B`));
      }
      document.getElementById("summary").textContent = summary.join("\n");
    }

    function exportGame() {
      const gameData = {
        teamA,
        teamB,
        scoreA,
        scoreB,
        currentSet,
        sets,
        server,
        lastScoringTeam,
        tournamentPhase,
        lastServerIndexA,
        lastServerIndexB
      };
      const json = JSON.stringify(gameData, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `jogo_volei_${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importGame(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = JSON.parse(e.target.result);
          teamA = data.teamA ?? ["Ana", "Bia"];
          teamB = data.teamB ?? ["Clara", "Duda"];
          scoreA = data.scoreA ?? 0;
          scoreB = data.scoreB ?? 0;
          currentSet = data.currentSet ?? 1;
          sets = data.sets ?? [];
          server = data.server ?? { team: 'A', index: 0 };
          lastScoringTeam = data.lastScoringTeam ?? null;
          tournamentPhase = data.tournamentPhase ?? "Fase de Grupos";
          lastServerIndexA = data.lastServerIndexA ?? 0;
          lastServerIndexB = data.lastServerIndexB ?? 0;

          document.getElementById("tournamentPhase").value = tournamentPhase;
          document.getElementById("set-info").textContent = `Set ${currentSet}`;

          historyStack.length = 0;
          renderPlayers();
          renderPlayerInputs();
          updateScores();
          renderSummary();
          saveState();
          alert("Jogo importado com sucesso!");
        } catch {
          alert("Arquivo JSON inválido.");
        }
      };
      reader.readAsText(file);
      event.target.value = "";
    }

    function finishGame() {
      if (sets.length === 0) {
        alert("Finalize ao menos um set antes de finalizar o jogo.");
        return;
      }
      // Guardar o jogo atual na lista de jogos finalizados
      const finalGame = {
        id: Date.now(),
        teamA,
        teamB,
        sets,
        winner: determineWinner(),
        tournamentPhase,
        date: new Date().toLocaleString()
      };
      finishedGames.push(finalGame);
      saveState();
      alert("Jogo finalizado e salvo.");

      // Resetar estado do jogo atual para um novo jogo
      resetCurrentGame();
      renderFinishedGames();
    }

    function determineWinner() {
      let winsA = 0;
      let winsB = 0;
      for (const s of sets) {
        if (s.scoreA > s.scoreB) winsA++;
        else if (s.scoreB > s.scoreA) winsB++;
      }
      if (winsA > winsB) return 'Time A';
      if (winsB > winsA) return 'Time B';
      return 'Empate';
    }

    function resetCurrentGame() {
      scoreA = 0;
      scoreB = 0;
      currentSet = 1;
      sets = [];
      server = { team: 'A', index: 0 };
      lastScoringTeam = null;
      tournamentPhase = "Fase de Grupos";
      lastServerIndexA = 0;
      lastServerIndexB = 0;
      historyStack.length = 0;
      document.getElementById("tournamentPhase").value = tournamentPhase;
      document.getElementById("set-info").textContent = `Set ${currentSet}`;
      renderPlayers();
      renderPlayerInputs();
      updateScores();
      renderSummary();
      saveState();
    }

    function renderFinishedGames() {
      const container = document.getElementById("finishedGamesList");
      if(finishedGames.length === 0) {
        container.innerHTML = "<i>Nenhum jogo finalizado salvo.</i>";
        return;
      }
      container.innerHTML = "";
      finishedGames.forEach(game => {
        const div = document.createElement("div");
        div.classList.add("finishedGame");
        div.innerHTML = `
          <div>
            <strong>${game.date} - ${game.tournamentPhase} - Vencedor: ${game.winner}</strong>
            <div>
              <button class="btn-small" onclick="viewFinishedGame(${game.id})">Ver detalhes</button>
              <button class="btn-small" onclick="loadFinishedGame(${game.id})">Reabrir jogo</button>
              <button class="btn-small" onclick="deleteFinishedGame(${game.id})" style="color:#d9534f;">Excluir</button>
            </div>
          </div>
          <div id="details-${game.id}" style="display:none; margin-top: 5px; font-size: 0.9rem;"></div>
        `;
        container.appendChild(div);
      });
    }

    function viewFinishedGame(id) {
      const detailsDiv = document.getElementById(`details-${id}`);
      if (!detailsDiv) return;

      if (detailsDiv.style.display === "block") {
        detailsDiv.style.display = "none";
        detailsDiv.textContent = "";
        return;
      }

      const game = finishedGames.find(g => g.id === id);
      if (!game) return;

      let text = `Time A: ${game.teamA.join(", ")}\n`;
      text += `Time B: ${game.teamB.join(", ")}\n`;
      text += "Sets:\n";
      game.sets.forEach(s => {
        text += `  Set ${s.setNumber}: Time A ${s.scoreA} x ${s.scoreB} Time B\n`;
      });

      detailsDiv.textContent = text;
      detailsDiv.style.display = "block";
    }

    function loadFinishedGame(id) {
      const game = finishedGames.find(g => g.id === id);
      if (!game) return alert("Jogo não encontrado.");

      // Substituir o estado atual pelo jogo finalizado selecionado
      teamA = [...game.teamA];
      teamB = [...game.teamB];
      sets = JSON.parse(JSON.stringify(game.sets));
      currentSet = sets.length + 1;
      scoreA = 0;
      scoreB = 0;
      server = { team: 'A', index: 0 };
      lastServerIndexA = 0;
      lastServerIndexB = 0;
      lastScoringTeam = null;
      tournamentPhase = game.tournamentPhase;

      document.getElementById("tournamentPhase").value = tournamentPhase;
      document.getElementById("set-info").textContent = `Set ${currentSet}`;

      historyStack.length = 0;
      renderPlayers();
      renderPlayerInputs();
      updateScores();
      renderSummary();
      saveState();

      alert("Jogo reaberto para edição. O placar atual está zerado para novo set.");
    }

    function deleteFinishedGame(id) {
      if(!confirm("Confirma excluir este jogo finalizado?")) return;
      finishedGames = finishedGames.filter(g => g.id !== id);
      saveState();
      renderFinishedGames();
    }

    // Inicialização
    loadState();
    renderPlayers();
    renderPlayerInputs();
    updateScores();
    renderSummary();
    renderFinishedGames();
  </script>
</body>
</html>
