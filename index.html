<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerenciador de Jogo de Duplas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    h1 {
      text-align: center;
    }
    .hidden {
      display: none;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    input, select, button {
      margin: 5px 0;
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
    }
    .section-title {
      margin-top: 20px;
      font-weight: bold;
      border-bottom: 1px solid #ccc;
      padding-bottom: 4px;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Gerenciador de Jogo de Duplas</h1>

  <div class="container" id="setupContainer">
    <div class="section-title">Configuração do Jogo</div>
    <label>Nome da Dupla A:</label>
    <input id="teamAName" placeholder="Ex: Equipe Azul">

    <label>Jogadores da Dupla A (separados por vírgula):</label>
    <input id="teamAPlayers" placeholder="Ex: Ana, Beto">

    <label>Nome da Dupla B:</label>
    <input id="teamBName" placeholder="Ex: Equipe Vermelha">

    <label>Jogadores da Dupla B (separados por vírgula):</label>
    <input id="teamBPlayers" placeholder="Ex: Clara, Diego">

    <label>Fase do Torneio:</label>
    <select id="tournamentPhaseSelect">
      <option value="">Selecione</option>
      <option value="Quartas">Quartas</option>
      <option value="Semifinal">Semifinal</option>
      <option value="Final">Final</option>
    </select>

    <label>Quem começa sacando?</label>
    <select id="initialServerTeam">
      <option value="">Selecione a dupla</option>
      <option value="A">Dupla A</option>
      <option value="B">Dupla B</option>
    </select>

    <label>Qual jogador da dupla inicia sacando? (índice 0 ou 1)</label>
    <input id="initialServerIndex" type="number" min="0" max="1" placeholder="0 ou 1">

    <button onclick="startGame()">Iniciar Jogo</button>
  </div>

  <div class="container hidden" id="gameContainer">
    <div id="displayTeams" class="section-title"></div>
    <div><b>Fase:</b> <span id="displayPhase"></span></div>
    <div><b>Sacando:</b> <span id="displayServer"></span></div>

    <div style="margin-top: 10px;">
      <button onclick="scorePoint('A')">Ponto para Dupla A</button>
      <button onclick="scorePoint('B')">Ponto para Dupla B</button>
    </div>

    <div style="margin-top: 10px;">
      <button onclick="undo()" id="undoBtn" disabled>Desfazer último ponto</button>
      <button onclick="finishGame()">Finalizar Jogo</button>
      <button onclick="resetCurrentGame()">Novo Jogo</button>
    </div>

    <div class="section-title">Resumo do Jogo</div>
    <pre id="summary"></pre>

    <div class="section-title">Jogos Finalizados</div>
    <div id="finishedGamesList"><i>Nenhum jogo finalizado salvo.</i></div>
  </div>

  <script>
    let teamAName = "";
    let teamBName = "";
    let teamA = [];
    let teamB = [];
    let scoreA = 0;
    let scoreB = 0;
    let currentSet = 1;
    let sets = [];
    let server = null;
    let lastScoringTeam = null;
    let tournamentPhase = "";
    let lastServerIndexA = 0;
    let lastServerIndexB = 0;
    let historyStack = [];
    let finishedGames = [];

    function startGame() {
      teamAName = document.getElementById("teamAName").value.trim();
      teamBName = document.getElementById("teamBName").value.trim();
      teamA = document.getElementById("teamAPlayers").value.split(",").map(p => p.trim());
      teamB = document.getElementById("teamBPlayers").value.split(",").map(p => p.trim());
      tournamentPhase = document.getElementById("tournamentPhaseSelect").value;
      const initialServerTeam = document.getElementById("initialServerTeam").value;
      const initialServerIndex = parseInt(document.getElementById("initialServerIndex").value);

      if (!teamAName || !teamBName || teamA.length !== 2 || teamB.length !== 2 || !tournamentPhase || !["A", "B"].includes(initialServerTeam) || isNaN(initialServerIndex) || initialServerIndex < 0 || initialServerIndex > 1) {
        alert("Preencha todos os campos corretamente.");
        return;
      }

      server = initialServerTeam === "A" ? teamA[initialServerIndex] : teamB[initialServerIndex];
      lastServerIndexA = lastServerIndexB = initialServerIndex;

      document.getElementById("setupContainer").classList.add("hidden");
      document.getElementById("gameContainer").classList.remove("hidden");
      document.getElementById("displayTeams").textContent = `${teamAName} x ${teamBName}`;
      document.getElementById("displayPhase").textContent = tournamentPhase;
      updateScores();
      renderPlayers();
      renderSummary();
      renderFinishedGames();
    }

    function scorePoint(team) {
      historyStack.push({ scoreA, scoreB, server, lastServerIndexA, lastServerIndexB });
      document.getElementById("undoBtn").disabled = false;

      if (team === "A") {
        scoreA++;
        lastScoringTeam = "A";
      } else {
        scoreB++;
        lastScoringTeam = "B";
      }

      rotateServer();
      updateScores();
      renderSummary();
    }

    function rotateServer() {
      if (lastScoringTeam === "A") {
        lastServerIndexA = 1 - lastServerIndexA;
        server = teamA[lastServerIndexA];
      } else {
        lastServerIndexB = 1 - lastServerIndexB;
        server = teamB[lastServerIndexB];
      }
      renderPlayers();
    }

    function renderPlayers() {
      document.getElementById("displayServer").textContent = server;
    }

    function updateScores() {
      document.getElementById("summary").textContent = `Set ${currentSet}:\n${teamAName}: ${scoreA} | ${teamBName}: ${scoreB}`;
    }

    function undo() {
      if (!historyStack.length) return;
      const lastState = historyStack.pop();
      scoreA = lastState.scoreA;
      scoreB = lastState.scoreB;
      server = lastState.server;
      lastServerIndexA = lastState.lastServerIndexA;
      lastServerIndexB = lastState.lastServerIndexB;

      renderPlayers();
      updateScores();
      renderSummary();

      if (historyStack.length === 0) {
        document.getElementById("undoBtn").disabled = true;
      }
    }

    function renderSummary() {
      document.getElementById("summary").textContent = `Set ${currentSet}:\n${teamAName}: ${scoreA} | ${teamBName}: ${scoreB}`;
    }

    function finishGame() {
      if (scoreA === 0 && scoreB === 0) {
        alert("Nenhum ponto foi marcado.");
        return;
      }

      sets.push({ setNumber: currentSet, scoreA, scoreB });
      const gameData = { teamAName, teamBName, teamA, teamB, sets, tournamentPhase };
      finishedGames.push(gameData);
      alert("Jogo finalizado e salvo.");
      saveState();
      resetCurrentGame();
    }

    function resetCurrentGame() {
      teamAName = "";
      teamBName = "";
      teamA = [];
      teamB = [];
      scoreA = 0;
      scoreB = 0;
      currentSet = 1;
      sets = [];
      server = null;
      lastScoringTeam = null;
      tournamentPhase = "";
      lastServerIndexA = 0;
      lastServerIndexB = 0;
      historyStack = [];

      document.getElementById("setupContainer").classList.remove("hidden");
      document.getElementById("gameContainer").classList.add("hidden");

      document.getElementById("teamAName").value = "";
      document.getElementById("teamAPlayers").value = "";
      document.getElementById("teamBName").value = "";
      document.getElementById("teamBPlayers").value = "";
      document.getElementById("tournamentPhaseSelect").value = "";
      document.getElementById("initialServerTeam").value = "";
      document.getElementById("initialServerIndex").value = "";
      document.getElementById("summary").textContent = "";
    }

    function renderFinishedGames() {
      const container = document.getElementById("finishedGamesList");
      if (finishedGames.length === 0) {
        container.innerHTML = "<i>Nenhum jogo finalizado salvo.</i>";
        return;
      }

      container.innerHTML = "";
      finishedGames.forEach((game, i) => {
        const div = document.createElement("div");
        div.innerHTML = `<b>Jogo ${i + 1}:</b> ${game.teamAName} x ${game.teamBName} - ${game.tournamentPhase}
          <button onclick="viewFinishedGame(${i})">Ver</button>
          <button onclick="deleteFinishedGame(${i})">Excluir</button>`;
        container.appendChild(div);
      });
    }

    function viewFinishedGame(index) {
      const g = finishedGames[index];
      let text = `Jogo: ${g.teamAName} x ${g.teamBName}\nFase: ${g.tournamentPhase}\n\nSets:\n`;
      g.sets.forEach(s => {
        text += `Set ${s.setNumber}: ${g.teamAName} ${s.scoreA} x ${s.scoreB} ${g.teamBName}\n`;
      });
      alert(text);
    }

    function deleteFinishedGame(index) {
      finishedGames.splice(index, 1);
      renderFinishedGames();
      saveState();
    }

    function saveState() {
      localStorage.setItem("finishedGames", JSON.stringify(finishedGames));
    }

    function loadState() {
      try {
        const data = localStorage.getItem("finishedGames");
        if (data) {
          finishedGames = JSON.parse(data);
          renderFinishedGames();
        }
      } catch {
        console.warn("Erro ao carregar estado salvo.");
      }
    }

    window.onload = () => {
      loadState();
    };
  </script>
</body>
</html>
